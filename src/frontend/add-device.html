<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HomeMaestro - Add Device</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #87cefa 0%, #e0f4ff 100%);
        min-height: 100vh;
        padding: 40px 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      h1 {
        color: #2c3e50;
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 700;
      }

      h1 a {
        color: #2c3e50;
        text-decoration: none;
        transition: opacity 0.3s;
      }

      h1 a:hover {
        opacity: 0.7;
      }

      h2 {
        color: #34495e;
        font-size: 1.3em;
        font-weight: 400;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        padding: 35px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 0.95em;
      }

      input[type="text"],
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e8e8e8;
        border-radius: 8px;
        font-size: 1em;
        font-family: inherit;
        transition: border-color 0.3s;
      }

      input[type="text"]:focus,
      select:focus {
        outline: none;
        border-color: #87cefa;
      }

      .button-group {
        display: flex;
        gap: 12px;
        margin-top: 25px;
      }

      button {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-size: 1.05em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .btn-primary {
        background: #87cefa;
        color: white;
      }

      .btn-primary:hover {
        background: #6db3e8;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #ecf0f1;
        color: #7f8c8d;
      }

      .btn-secondary:hover {
        background: #d5dbdb;
      }

      .message {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 500;
        font-size: 0.95em;
      }

      .success {
        background: #d5f4e6;
        color: #27ae60;
      }

      .error {
        background: #fadbd8;
        color: #e74c3c;
      }

      #featuresContainer {
        border: 2px dashed #e8e8e8;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
      }

      .feature-item {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 10px;
      }

      .feature-item:last-child {
        margin-bottom: 0;
      }

      @media (max-width: 768px) {
        h1 {
          font-size: 2em;
        }

        .container {
          padding: 25px 20px;
        }

        .button-group {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1><a href="index.html">HomeMaestro</a></h1>
      <h2>Add New Device</h2>
    </div>

    <div class="container">
      <div id="message" style="display: none"></div>

      <form id="deviceForm">
        <div class="form-group">
          <label for="deviceName">Device Name</label>
          <input
            type="text"
            id="deviceName"
            name="name"
            required
            placeholder="Enter device name"
          />
        </div>

        <div class="form-group">
          <label for="deviceType">Device Type</label>
          <select id="deviceType" name="type" required>
            <option value="">Select a type</option>
            <option value="Device">Device</option>
            <option value="Hub">Hub</option>
          </select>
        </div>

        <div class="form-group" id="subTypeGroup" style="display: none">
          <label for="subType" id="subTypeLabel">Protocol</label>
          <select id="subType" name="subType" required></select>
        </div>

        <div class="form-group">
          <label for="deviceStatus">Status</label>
          <select id="deviceStatus" name="status" required>
            <option value="online">Online</option>
            <option value="offline">Offline</option>
          </select>
        </div>

        <div id="featuresSection" style="display: none">
          <div class="form-group">
            <label>Features</label>
            <div id="featuresContainer">
              <div id="featuresList"></div>
              <button
                type="button"
                class="btn-secondary"
                onclick="addFeature()"
                style="width: 100%; margin-top: 10px"
              >
                Add Feature
              </button>
            </div>
          </div>
        </div>
        
        <div class="button-group">
          <button
            type="button"
            class="btn-secondary"
            onclick="window.location.href='index.html'"
          >
            Cancel
          </button>
          <button type="submit" class="btn-primary">Add Device</button>
        </div>
      </form>
    </div>

    <script>
      const API_URL = "http://127.0.0.1:5000/devices/";

      const protocolOptions = [
        { value: "HubLess", label: "HubLess" },
        { value: "Hue", label: "Hue" },
        { value: "ZWave", label: "Z-Wave" },
        { value: "Tradfri", label: "Tradfri" },
        { value: "Zigbee", label: "Zigbee" },
      ];

      const hubTypeOptions = [
        { value: "HueHub", label: "Hue Hub" },
        { value: "TradfriHub", label: "Tradfri Hub" },
        { value: "ZigbeeHub", label: "Zigbee Hub" },
        { value: "ZWaveHub", label: "Z-Wave Hub" },
      ];

      document
        .getElementById("deviceType")
        .addEventListener("change", function () {
          const subTypeGroup = document.getElementById("subTypeGroup");
          const subTypeLabel = document.getElementById("subTypeLabel");
          const subTypeSelect = document.getElementById("subType");
          const featuresSection = document.getElementById("featuresSection");
          const selectedType = this.value;

          subTypeSelect.innerHTML = "";

          if (selectedType === "Device") {
            subTypeLabel.textContent = "Protocol";
            subTypeSelect.innerHTML =
              '<option value="">Select a protocol</option>';
            protocolOptions.forEach((opt) => {
              subTypeSelect.innerHTML += `<option value="${opt.value}">${opt.label}</option>`;
            });
            subTypeGroup.style.display = "block";
            subTypeSelect.required = true;
            featuresSection.style.display = "block";
          } else if (selectedType === "Hub") {
            subTypeLabel.textContent = "Hub Type";
            subTypeSelect.innerHTML =
              '<option value="">Select a hub type</option>';
            hubTypeOptions.forEach((opt) => {
              subTypeSelect.innerHTML += `<option value="${opt.value}">${opt.label}</option>`;
            });
            subTypeGroup.style.display = "block";
            subTypeSelect.required = true;
            featuresSection.style.display = "none";
          } else {
            subTypeGroup.style.display = "none";
            featuresSection.style.display = "none";
            subTypeSelect.required = false;
          }
        });

      function showMessage(text, type) {
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = "block";

        setTimeout(() => {
          messageDiv.style.display = "none";
        }, 5000);
      }

      document
        .getElementById("deviceForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const deviceType = document.getElementById("deviceType").value;
          const subType = document.getElementById("subType").value;

          const features = getFeaturesData();

          console.log(features);

          const formData = {
            name: document.getElementById("deviceName").value,
            status: document.getElementById("deviceStatus").value,
          };

          if (deviceType === "Device") {
            formData.protocol = subType;
          } else if (deviceType === "Hub") {
            formData.type = subType;
          }

          if (features.length > 0) {
            formData.features = features;
          }

          try {
            const response = await fetch(API_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            showMessage("Device added successfully!", "success");

            setTimeout(() => {
              window.location.href = "devices.html";
            }, 1500);
          } catch (error) {
            console.error("Error adding device:", error);
            showMessage(`Failed to add device: ${error.message}`, "error");
          }
        });

      let featureIdCounter = 0;

      const featureTemplates = {
        LampFeature: `
          <div class="form-group">
            <label>State (On/Off)</label>
            <input type="checkbox" data-parameter="state">
          </div>
          <div class="form-group">
            <label>Brightness</label>
            <input type="number" data-parameter="brightness" placeholder="0-100" min="0" max="100">
          </div>
        `,
        BlindsFeature: `
          <div class="form-group">
            <label>Position</label>
            <input type="number" data-parameter="position" placeholder="0-100" min="0" max="100">
          </div>
        `,
        TemperatureFeature: `
          <div class="form-group">
            <label>Temperature</label>
            <input type="number" data-parameter="temperature" placeholder="e.g., 21">
          </div>
        `,
      };

      function addFeature() {
        const featureId = featureIdCounter++;
        const featuresList = document.getElementById("featuresList");
        const featureDiv = document.createElement("div");
        featureDiv.className = "feature-item";
        featureDiv.id = `feature-${featureId}`;
        featureDiv.innerHTML = `
          <div class="form-group">
            <label>Feature Name</label>
            <input type="text" class="feature-name" placeholder="e.g., Living Room Light" required>
          </div>
          <div class="form-group">
            <label>Feature Type</label>
            <select class="feature-type-select" onchange="updateFeatureParameters(${featureId})">
              <option value="">Select feature type</option>
              <option value="LampFeature">Lamp</option>
              <option value="BlindsFeature">Blinds</option>
              <option value="TemperatureFeature">Temperature</option>
            </select>
          </div>
          <div class="feature-parameters"></div>
          <button type="button" class="btn-secondary" style="background: #e74c3c; color: white; width: 100%;" onclick="removeFeature(${featureId})">Remove</button>
        `;
        featuresList.appendChild(featureDiv);
      }

      function removeFeature(featureId) {
        const featureDiv = document.getElementById(`feature-${featureId}`);
        if (featureDiv) {
          featureDiv.remove();
        }
      }

      function updateFeatureParameters(featureId) {
        const featureDiv = document.getElementById(`feature-${featureId}`);
        const select = featureDiv.querySelector(".feature-type-select");
        const parametersDiv = featureDiv.querySelector(".feature-parameters");
        const featureType = select.value;

        parametersDiv.innerHTML = featureTemplates[featureType] || "";
      }

      function getFeaturesData() {
        const features = [];
        const featureElements = document.querySelectorAll(".feature-item");

        featureElements.forEach((featureEl) => {
          const type = featureEl.querySelector(".feature-type-select").value;
          const name = featureEl.querySelector(".feature-name").value;
          if (!type || !name) return;

          const featureData = { type: type.replace('Feature', '').toLowerCase(), name: name, options: {} };
          const parameterElements = featureEl.querySelectorAll(
            ".feature-parameters [data-parameter]"
          );

          parameterElements.forEach((paramEl) => {
            const key = paramEl.dataset.parameter;
            let value;
            if (paramEl.type === "checkbox") {
              value = paramEl.checked;
            } else if (paramEl.type === "number") {
              value = paramEl.value ? parseFloat(paramEl.value) : undefined;
            } else {
              value = paramEl.value;
            }
            if (value !== undefined) featureData.options[key] = value;
          });
          features.push(featureData);
        });
        return features;
      }
    </script>
  </body>
</html>
